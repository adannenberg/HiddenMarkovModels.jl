<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Custom HMM · HiddenMarkovModels.jl</title><meta name="title" content="Custom HMM · HiddenMarkovModels.jl"/><meta property="og:title" content="Custom HMM · HiddenMarkovModels.jl"/><meta property="twitter:title" content="Custom HMM · HiddenMarkovModels.jl"/><meta name="description" content="Documentation for HiddenMarkovModels.jl."/><meta property="og:description" content="Documentation for HiddenMarkovModels.jl."/><meta property="twitter:description" content="Documentation for HiddenMarkovModels.jl."/><meta property="og:url" content="https://gdalle.github.io/HiddenMarkovModels.jl/tuto_custom/"/><meta property="twitter:url" content="https://gdalle.github.io/HiddenMarkovModels.jl/tuto_custom/"/><link rel="canonical" href="https://gdalle.github.io/HiddenMarkovModels.jl/tuto_custom/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="HiddenMarkovModels.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">HiddenMarkovModels.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Essentials</span><ul><li><a class="tocitem" href="../background/">Background</a></li><li><a class="tocitem" href="../api/">API reference</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../tuto_builtin/">Built-in HMM</a></li><li class="is-active"><a class="tocitem" href>Custom HMM</a><ul class="internal"><li><a class="tocitem" href="#Interface"><span>Interface</span></a></li><li><a class="tocitem" href="#Example"><span>Example</span></a></li></ul></li><li><a class="tocitem" href="../debugging/">Debugging</a></li></ul></li><li><span class="tocitem">Alternatives</span><ul><li><a class="tocitem" href="../alt_features/">Features</a></li></ul></li><li><span class="tocitem">Advanced</span><ul><li><a class="tocitem" href="../formulas/">Formulas</a></li><li><a class="tocitem" href="../roadmap/">Roadmap</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Custom HMM</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Custom HMM</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gdalle/HiddenMarkovModels.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gdalle/HiddenMarkovModels.jl/blob/main/docs/src/tuto_custom.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial-custom-HMM"><a class="docs-heading-anchor" href="#Tutorial-custom-HMM">Tutorial - custom HMM</a><a id="Tutorial-custom-HMM-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial-custom-HMM" title="Permalink"></a></h1><p>The built-in HMM is perfect when the initial state distribution, transition matrix and emission distributions can be updated independently with Maximum Likelihood Estimation. But some of these parameters might be correlated, or fixed. Or they might come with a prior, which forces you to use Maximum A Posteriori instead.</p><p>In such cases, it is necessary to implement a new subtype of <a href="../api/#HiddenMarkovModels.AbstractHMM"><code>AbstractHMM</code></a> with all its required methods.</p><pre><code class="language-julia hljs">using Distributions
using HiddenMarkovModels
using LinearAlgebra
using RequiredInterfaces
using StatsAPI

using Random; Random.seed!(63)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Random.TaskLocalRNG()</code></pre><h2 id="Interface"><a class="docs-heading-anchor" href="#Interface">Interface</a><a id="Interface-1"></a><a class="docs-heading-anchor-permalink" href="#Interface" title="Permalink"></a></h2><p>To ascertain that a type indeed satisfies the interface, you can use <a href="https://github.com/Seelengrab/RequiredInterfaces.jl">RequiredInterfaces.jl</a>.</p><pre><code class="language-julia hljs">RequiredInterfaces.check_interface_implemented(AbstractHMM, HMM)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><p>If your implementation is insufficient, the test will list missing methods.</p><pre><code class="language-julia hljs">struct EmptyHMM end
RequiredInterfaces.check_interface_implemented(AbstractHMM, EmptyHMM)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">4-element Vector{Tuple{Any, Tuple}}:
 (HiddenMarkovModels.initial_distribution, (Main.EmptyHMM,))
 (HiddenMarkovModels.transition_matrix, (Main.EmptyHMM,))
 (length, (Main.EmptyHMM,))
 (HiddenMarkovModels.obs_distribution, (Main.EmptyHMM, Integer))</code></pre><p>Note that this test does not check the <code>StatsAPI.fit!</code> method. Since it is only used in the Baum-Welch algorithm, it is an optional part of the <code>AbstractHMM</code> interface.</p><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>We show how to implement an HMM whose initial distribution is always the equilibrium distribution of the underlying Markov chain. The code that follows is not efficient (it leads to a lot of allocations), but it would be fairly easy to optimize if needed.</p><p>The equilibrium distribution of a Markov chain is the (only) left eigenvector associated with the left eigenvalue <span>$1$</span>.</p><pre><code class="language-julia hljs">function markov_equilibrium(A)
    p = real.(eigvecs(A&#39;)[:, end])
    return p ./ sum(p)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">markov_equilibrium (generic function with 1 method)</code></pre><p>We now define our custom HMM by taking inspiration from <code>src/types/hmm.jl</code> and making a few modifications:</p><pre><code class="language-julia hljs">struct EquilibriumHMM{R,D} &lt;: AbstractHMM
    trans::Matrix{R}
    dists::Vector{D}
end</code></pre><p>The interface is only different as far as the initialization is concerned.</p><pre><code class="language-julia hljs">Base.length(hmm::EquilibriumHMM) = length(hmm.dists)
HMMs.initial_distribution(hmm::EquilibriumHMM) = markov_equilibrium(hmm.trans)  # this is new
HMMs.transition_matrix(hmm::EquilibriumHMM) = hmm.trans
HMMs.obs_distribution(hmm::EquilibriumHMM, i::Integer) = hmm.dists[i]</code></pre><p>As for fitting, we simply ignore the initialization count and copy the rest of the original code (with a few simplifications):</p><pre><code class="language-julia hljs">function StatsAPI.fit!(
    hmm::EquilibriumHMM{R,D}, init_count, trans_count, obs_seq, state_marginals
) where {R,D}
    hmm.trans .= trans_count ./ sum(trans_count, dims=2)
    for i in 1:N
        hmm.dists[i] = fit(D, obs_seq, state_marginals[i, :])
    end
end</code></pre><p>Let&#39;s take our new model for a spin:</p><pre><code class="language-julia hljs">function gaussian_equilibrium_hmm(N; noise=0)
    A = rand_trans_mat(N)
    dists = [Normal(i + noise * randn(), 0.5) for i in 1:N]
    return EquilibriumHMM(A, dists)
end;</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">gaussian_equilibrium_hmm (generic function with 1 method)</code></pre><pre><code class="language-julia hljs">N = 3
hmm = gaussian_equilibrium_hmm(N);
transition_matrix(hmm)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3×3 Matrix{Float64}:
 0.323233  0.512336   0.164431
 0.337336  0.0936302  0.569033
 0.474491  0.211947   0.313561</code></pre><pre><code class="language-julia hljs">[obs_distribution(hmm, i) for i in 1:N]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Vector{Distributions.Normal{Float64}}:
 Distributions.Normal{Float64}(μ=1.0, σ=0.5)
 Distributions.Normal{Float64}(μ=2.0, σ=0.5)
 Distributions.Normal{Float64}(μ=3.0, σ=0.5)</code></pre><p>We can estimate parameters based on several observation sequences. Note that as soon as we tamper with the re-estimation procedure, the loglikelihood is no longer guaranteed to increase during Baum-Welch, which is why we turn off the corresponding check.</p><pre><code class="language-julia hljs">T = 1000
nb_seqs = 10
obs_seqs = [rand(hmm, T).obs_seq for _ in 1:nb_seqs]

hmm_init = gaussian_equilibrium_hmm(N; noise=1)
hmm_est, logL_evolution = baum_welch(
    hmm_init, obs_seqs, nb_seqs; check_loglikelihood_increasing=false
);
first(logL_evolution), last(logL_evolution)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(-17307.286492829546, -13337.801784503825)</code></pre><p>Let&#39;s correct the state order:</p><pre><code class="language-julia hljs">[obs_distribution(hmm_est, i) for i in 1:N]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Vector{Distributions.Normal{Float64}}:
 Distributions.Normal{Float64}(μ=1.9404786167468473, σ=0.6496419328231631)
 Distributions.Normal{Float64}(μ=0.930296877525174, σ=0.47166343544319406)
 Distributions.Normal{Float64}(μ=3.0460653027007543, σ=0.494122026073601)</code></pre><pre><code class="language-julia hljs">perm = sortperm(1:3, by=i-&gt;obs_distribution(hmm_est, i).μ)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Vector{Int64}:
 2
 1
 3</code></pre><pre><code class="language-julia hljs">hmm_est = PermutedHMM(hmm_est, perm)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">PermutedHMM{Main.EquilibriumHMM{Float64, Distributions.Normal{Float64}}}(Main.EquilibriumHMM{Float64, Distributions.Normal{Float64}}([0.25477463139727424 0.2654852598068748 0.4797401087958509; 0.7323102875826278 0.22678950797530853 0.04090020444206378; 0.30450943470736475 0.4318947351981905 0.2635958300944448], Distributions.Normal{Float64}[Distributions.Normal{Float64}(μ=1.9404786167468473, σ=0.6496419328231631), Distributions.Normal{Float64}(μ=0.930296877525174, σ=0.47166343544319406), Distributions.Normal{Float64}(μ=3.0460653027007543, σ=0.494122026073601)]), [2, 1, 3])</code></pre><p>And finally evaluate the errors:</p><pre><code class="language-julia hljs">cat(transition_matrix(hmm_est), transition_matrix(hmm), dims=3)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3×3×2 Array{Float64, 3}:
[:, :, 1] =
 0.22679   0.73231   0.0409002
 0.265485  0.254775  0.47974
 0.431895  0.304509  0.263596

[:, :, 2] =
 0.323233  0.512336   0.164431
 0.337336  0.0936302  0.569033
 0.474491  0.211947   0.313561</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../tuto_builtin/">« Built-in HMM</a><a class="docs-footer-nextpage" href="../debugging/">Debugging »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Tuesday 31 October 2023 17:51">Tuesday 31 October 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
